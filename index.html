<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ã‚­ãƒ©ã‚­ãƒ©ï¼ç´„åˆ†ãƒã‚¹ã‚¿ãƒ¼</title>
    <meta name="description" content="å°å­¦ç”Ÿå‘ã‘ï¼šæ¥½ã—ãå­¦ã¹ã‚‹åˆ†æ•°ã®ç´„åˆ†ã‚¢ãƒ—ãƒª">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- æ—¥æœ¬èªã®æ‰‹æ›¸ãé¢¨ãƒ•ã‚©ãƒ³ãƒˆï¼šKiwi Maru -->
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@500&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body {
            font-family: 'Kiwi Maru', serif;
            background-color: #FFF9F0; /* ç›®ã«å„ªã—ã„ã‚¯ãƒªãƒ¼ãƒ è‰² */
            /* overflow: hidden;  <-- å‰Šé™¤: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */
            overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨±å¯ */
            /* touch-action: none; <-- å¤‰æ›´: ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œã‚’è¨±å¯ */
            touch-action: pan-y; 
            user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠé˜²æ­¢ */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ --- */
        .fraction-line {
            height: 4px;
            background-color: #1F2937; /* gray-800 */
            width: 100%;
            border-radius: 2px;
        }

        /* ã·ã‚‹ã‚“ã¨æŠ¼ã›ã‚‹ãƒœã‚¿ãƒ³ */
        .bubble-btn {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .bubble-btn:active {
            transform: scale(0.92);
        }

        /* å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ */
        .input-box {
            transition: all 0.2s;
            cursor: pointer;
        }
        .input-box.active {
            background-color: #E0F2FE; /* blue-50 */
            border-color: #3B82F6; /* blue-500 */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        /* ãƒ†ãƒ³ã‚­ãƒ¼ã®ãƒœã‚¿ãƒ³ */
        .key-btn {
            background: white;
            border-bottom: 4px solid #E2E8F0; /* gray-200 */
        }
        .key-btn:active {
            border-bottom-width: 0;
            transform: translateY(4px);
        }

        /* å¹ãå‡ºã—ã‚¹ã‚¿ã‚¤ãƒ« */
        .speech-bubble {
            position: relative;
            background: #ffffff;
            border: 3px solid #FBCFE8; /* pink-200 */
            border-radius: 1.2rem;
            padding: 8px 12px;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
        }
        /* å¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆä¸‹ï¼‰ */
        .bubble-bottom::after {
            content: '';
            position: absolute;
            left: 50%; bottom: -12px; transform: translateX(-50%);
            border-width: 12px 10px 0; border-style: solid;
            border-color: #FBCFE8 transparent transparent;
        }
        .bubble-bottom::before {
            content: '';
            position: absolute;
            left: 50%; bottom: -8px; transform: translateX(-50%);
            border-width: 10px 8px 0; border-style: solid;
            border-color: #ffffff transparent transparent;
            z-index: 1;
        }
        /* å¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆå·¦ï¼‰ */
        .bubble-left::after {
            content: '';
            position: absolute;
            left: -12px; top: 50%; transform: translateY(-50%);
            border-width: 8px 12px 8px 0; border-style: solid;
            border-color: transparent #FBCFE8 transparent transparent;
        }
        .bubble-left::before {
            content: '';
            position: absolute;
            left: -8px; top: 50%; transform: translateY(-50%);
            border-width: 6px 10px 6px 0; border-style: solid;
            border-color: transparent #ffffff transparent transparent;
            z-index: 1;
        }

        /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        .float-anim {
            animation: floating 3s ease-in-out infinite;
        }
        @keyframes floating {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-6px) rotate(2deg); }
        }

        .maru-anim {
            animation: maru-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
        }
        @keyframes maru-pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ä¼èª¬ã®ç‹ç”¨ï¼šè¼ãã‚ªãƒ¼ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shine-spin {
            0% { transform: translate(-50%, -50%) rotate(0deg) scale(1); opacity: 0.8; }
            50% { transform: translate(-50%, -50%) rotate(180deg) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(360deg) scale(1); opacity: 0.8; }
        }
        .legend-aura {
            animation: shine-spin 4s linear infinite;
            background: radial-gradient(circle, rgba(253,224,71,0.6) 0%, rgba(234,179,8,0.3) 60%, rgba(255,255,255,0) 80%);
            box-shadow: 0 0 20px 5px rgba(250, 204, 21, 0.4);
        }

        /* --- ãƒ¡ãƒ¢æ©Ÿèƒ½ & ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ --- */
        #memo-layer {
            position: absolute;
            /* å•é¡Œã®åˆ†æ•°ã‚’ä¸­å¿ƒã«é…ç½® */
            width: 240px;
            height: 280px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
            pointer-events: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é€é */
        }
        #memo-layer.active {
            pointer-events: auto;
        }
        .memo-container {
            position: absolute; inset: 0;
            border: 3px dashed #3B82F6;
            border-radius: 1.5rem;
            background: rgba(239, 246, 255, 0.6);
            pointer-events: none;
        }
        #memo-canvas {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            touch-action: none; cursor: crosshair;
        }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¨ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
        .char-wrapper {
            position: relative; display: inline-block;
            /* çµµæ–‡å­—è‡ªä½“ã¯z-index:10ã§ãƒãƒ³ãƒˆã‚„ã‚ªãƒ¼ãƒ©ã®ä¸Šã«è¡¨ç¤º */
            z-index: 10;
        }
        /* çµµæ–‡å­—æœ¬ä½“ã‚’ç›¸å¯¾é…ç½®ã—ã¦z-indexã‚’åŠ¹ã‹ã›ã‚‹ */
        .char-body {
            position: relative; z-index: 10;
        }
        
        .accessory {
            position: absolute; pointer-events: none; z-index: 20;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* ã‚ªãƒ¼ãƒ©ï¼ˆèƒŒæ™¯ï¼‰ */
        .aura-bg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 140%; height: 140%;
            border-radius: 50%;
            z-index: -10; /* ã‚­ãƒ£ãƒ©ã®çœŸå¾Œã‚ */
            pointer-events: none;
        }
        
        /* èµ¤ã„ãƒãƒ³ãƒˆï¼ˆCSSæç”»ï¼‰ */
        .red-cape {
            position: absolute;
            bottom: 0px; left: 50%;
            transform: translateX(-50%);
            width: 120%; height: 80%;
            background: #EF4444; /* red-500 */
            border-radius: 40% 40% 10% 10%;
            z-index: -5; /* ã‚ªãƒ¼ãƒ©ã‚ˆã‚Šå‰ã€ã‚­ãƒ£ãƒ©ã‚ˆã‚Šå¾Œã‚ */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* ç´™å¹é›ªç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        canvas#confetti-canvas {
            pointer-events: none;
            position: fixed; top: 0; left: 0;
            z-index: 100;
        }

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ï¼ˆçŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1rem;
            padding-right: 2rem;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="app" class="bg-white p-4 rounded-[2rem] shadow-2xl border-4 sm:border-8 border-yellow-200 w-full h-[95vh] max-h-[800px] max-w-md flex flex-col relative overflow-y-auto">
        
        <!-- ====================
             ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
        ==================== -->
        <div id="start-screen" class="absolute inset-0 z-[50] bg-white flex flex-col items-center justify-between p-4 text-center pb-8 overflow-y-auto">
            <div class="mt-4 shrink-0">
                <h1 class="text-3xl font-bold text-pink-500 mb-2 tracking-widest">åˆ†æ•°ã®ç´„åˆ†<br>ãƒã‚¹ã‚¿ãƒ¼</h1>
                <p class="text-gray-500 font-bold text-sm">ã„ã£ã—ã‚‡ã«å‹‰å¼·ã™ã‚‹å‹ã ã¡ã‚’é¸ã¼ã†ï¼</p>
            </div>

            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ -->
            <div class="flex gap-4 shrink-0">
                <button class="bubble-btn w-16 h-16 bg-blue-50 rounded-2xl text-3xl flex items-center justify-center border-4 border-transparent hover:border-blue-300 focus:border-blue-400 focus:outline-none ring-offset-2 focus:ring-2 ring-blue-200" onclick="selectChar('ğŸ¦‰', 'ãƒ•ã‚¯ãƒ­ã‚¦')">ğŸ¦‰</button>
                <button class="bubble-btn w-16 h-16 bg-blue-50 rounded-2xl text-3xl flex items-center justify-center border-4 border-transparent hover:border-blue-300 focus:border-blue-400 focus:outline-none ring-offset-2 focus:ring-2 ring-blue-200" onclick="selectChar('ğŸ¥', 'ãƒ’ãƒ¨ã‚³')">ğŸ¥</button>
                <button class="bubble-btn w-16 h-16 bg-blue-50 rounded-2xl text-3xl flex items-center justify-center border-4 border-transparent hover:border-blue-300 focus:border-blue-400 focus:outline-none ring-offset-2 focus:ring-2 ring-blue-200" onclick="selectChar('ğŸ§¸', 'ã‚¯ãƒã•ã‚“')">ğŸ§¸</button>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="flex flex-col items-center w-full">
                <!-- å¹ãå‡ºã— -->
                <div class="speech-bubble bubble-bottom mb-4 w-64 min-h-[60px] flex items-center justify-center shrink-0">
                    <p id="start-char-talk" class="text-gray-700 font-bold text-sm leading-snug">ã‚ˆã‚ã—ãã­ï¼<br>ã„ã£ã—ã‚‡ã« ãŒã‚“ã°ã‚ã†ï¼</p>
                </div>
                
                <!-- ã‚­ãƒ£ãƒ©è¡¨ç¤º -->
                <div class="char-wrapper text-7xl float-anim mb-4 shrink-0" id="start-char-view">
                    <div id="start-aura"></div>
                    <span id="preview-emoji" class="char-body">ğŸ¦‰</span>
                    <div id="start-accessories"></div>
                </div>
                
                <!-- ãƒ¬ãƒ™ãƒ«ç­‰ã®æƒ…å ± -->
                <div class="flex flex-col items-center gap-3 w-full px-8 shrink-0">
                    <div id="title-label" class="text-lg font-bold text-pink-500 bg-pink-50 px-6 py-1 rounded-full border border-pink-100">ã‹ã‘ã ã—ãƒ•ã‚¯ãƒ­ã‚¦</div>
                    
                    <div class="flex items-center gap-2">
                        <label for="level-select" class="text-xs font-bold text-gray-400">ãƒ¬ãƒ™ãƒ«:</label>
                        <select id="level-select" onchange="changeLevel(this.value)" class="custom-select bg-yellow-100 px-4 py-1.5 rounded-full text-yellow-800 font-bold text-sm border-2 border-yellow-200 outline-none focus:ring-2 focus:ring-yellow-300 transition-all cursor-pointer">
                            <!-- JSã§ç”Ÿæˆ -->
                        </select>
                    </div>
                    
                    <!-- é€²æ—ãƒãƒ¼ -->
                    <div class="flex flex-col items-center gap-1 w-full max-w-[200px]">
                        <div class="flex justify-between w-full text-[10px] font-bold text-gray-400 px-1">
                            <span>ã¼ã†ã‘ã‚“ã®ãã‚ã</span>
                            <span><span id="total-solved-display">0</span> / 100</span>
                        </div>
                        <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                            <div id="progress-fill" class="h-full bg-gradient-to-r from-blue-300 to-blue-500 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
            <button class="bubble-btn w-full h-16 bg-gradient-to-r from-pink-400 to-orange-400 text-white text-2xl font-bold rounded-2xl shadow-lg mt-2 mb-8 flex-none flex items-center justify-center gap-2" onclick="startGame()">
                <span>â–¶</span> ã‚¹ã‚¿ãƒ¼ãƒˆï¼
            </button>
        </div>

        <!-- ====================
             ã‚²ãƒ¼ãƒ ç”»é¢
        ==================== -->
        <div id="game-ui" class="hidden h-full flex flex-col justify-between">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="flex items-center justify-between mb-1 shrink-0">
                <button onclick="backToStart()" class="bubble-btn flex items-center gap-1 text-gray-400 text-xs font-bold hover:text-pink-400 px-2 py-2 rounded-lg hover:bg-gray-50">
                    <span>ğŸ </span> ã‚‚ã©ã‚‹
                </button>
                <div class="flex gap-2">
                    <div class="bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-bold text-xs border border-pink-200">
                        Lv.<span id="display-level">1</span>
                    </div>
                    <div class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full font-bold text-xs border border-yellow-200">
                        ã‚ã¨ <span id="display-remain">10</span>
                    </div>
                </div>
            </div>

            <!-- ã‚­ãƒ£ãƒ©ï¼†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="flex items-center gap-4 px-2 mb-1 h-20 shrink-0">
                <div class="char-wrapper text-5xl float-anim shrink-0" id="game-char-view">
                    <div id="game-aura"></div>
                    <span id="game-char" class="char-body">ğŸ¦‰</span>
                    <div id="game-accessories"></div>
                </div>
                <div class="speech-bubble bubble-left flex-grow py-2">
                    <p id="feedback-text" class="text-gray-700 font-bold text-sm leading-tight text-center">ç´„åˆ†ã—ã‚ˆã†ï¼</p>
                </div>
            </div>

            <!-- å•é¡Œã‚¨ãƒªã‚¢ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ -->
            <div class="flex-grow flex items-center justify-center px-2 relative -mt-4 mb-2">
                <div class="flex items-center gap-4 sm:gap-8 relative w-full justify-center">
                    
                    <!-- å‡ºé¡Œï¼ˆå·¦è¾ºï¼‰ -->
                    <div class="flex flex-col items-center w-16 sm:w-20 relative z-0">
                        <!-- ãƒ¡ãƒ¢æ©Ÿèƒ½ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
                        <div id="memo-layer" class="hidden">
                            <div class="memo-container"></div>
                            <canvas id="memo-canvas"></canvas>
                            <!-- ãƒ¡ãƒ¢æ¶ˆå»ãƒœã‚¿ãƒ³ -->
                            <button onclick="clearMemo()" class="pointer-events-auto absolute -top-10 left-1/2 -translate-x-1/2 bg-gray-600 text-white text-[10px] px-3 py-1.5 rounded-full shadow-lg active:scale-95 flex items-center gap-1 z-[70] w-max">
                                <span>ğŸ—‘ï¸</span> æ¶ˆã™
                            </button>
                        </div>

                        <div id="q-num" class="text-5xl font-bold text-gray-800 mb-2">4</div>
                        <div class="fraction-line"></div>
                        <div id="q-den" class="text-5xl font-bold text-gray-800 mt-2">8</div>
                    </div>

                    <div class="text-4xl text-gray-400 font-bold">=</div>

                    <!-- è§£ç­”ï¼ˆå³è¾ºï¼‰ -->
                    <div class="flex flex-col items-center w-24 relative z-[40]">
                        <div id="box-num" class="input-box w-20 h-16 sm:w-24 sm:h-20 flex items-center justify-center text-4xl font-bold border-4 border-gray-200 rounded-2xl bg-gray-50 text-blue-600 active" onclick="switchFocus('num')">?</div>
                        <div class="fraction-line my-2 bg-gray-800"></div>
                        <div id="box-den" class="input-box w-20 h-16 sm:w-24 sm:h-20 flex items-center justify-center text-4xl font-bold border-4 border-gray-200 rounded-2xl bg-gray-50 text-blue-600" onclick="switchFocus('den')">?</div>
                    </div>

                    <!-- æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                    <div id="correct-overlay" class="hidden absolute left-1/2 top-[50%] -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[80] flex flex-col items-center">
                        <svg width="180" height="180" viewBox="0 0 100 100" class="maru-anim">
                            <circle cx="50" cy="50" r="40" stroke="#FF4D4D" stroke-width="8" fill="none" stroke-linecap="round" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ†ãƒ³ã‚­ãƒ¼ï¼‰ -->
            <div class="bg-blue-50 p-3 rounded-[1.5rem] relative z-[50] shrink-0 border-2 border-blue-100">
                <!-- ãƒ¡ãƒ¢åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <button id="memo-btn" class="absolute -top-10 right-4 bg-blue-400 hover:bg-blue-500 text-white px-4 py-1.5 rounded-t-xl font-bold shadow-md transition-colors text-sm flex items-center gap-1" onclick="toggleMemo()">
                    <span>âœï¸</span> ãƒ¡ãƒ¢
                </button>

                <div class="grid grid-cols-3 gap-2">
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(1)">1</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(2)">2</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(3)">3</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(4)">4</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(5)">5</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(6)">6</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(7)">7</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(8)">8</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(9)">9</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-lg font-bold text-red-400 shadow-sm" onclick="clearNum()">ã‘ã™</button>
                    <button class="key-btn bubble-btn h-12 rounded-xl text-2xl font-bold text-gray-600 shadow-sm" onclick="inputNum(0)">0</button>
                    <!-- æ±ºå®šãƒœã‚¿ãƒ³ -->
                    <button id="check-btn" class="h-12 rounded-xl text-lg font-bold bg-pink-400 text-white shadow-[0_4px_0_#db2777] active:shadow-none active:translate-y-1 active:bg-pink-500 transition-colors" onclick="checkAnswer()">ã§ããŸï¼</button>
                </div>
            </div>
        </div>

        <!-- ãƒ­ãƒƒã‚¯é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="lock-modal" class="hidden fixed inset-0 z-[200] bg-black/40 flex items-center justify-center p-6 backdrop-blur-sm transition-opacity">
            <div class="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-[280px] animate-[popIn_0.3s_ease-out]">
                <div class="text-5xl mb-4">ğŸ”’</div>
                <p id="lock-message" class="text-gray-700 font-bold mb-6 text-lg">å‰ã®ãƒ¬ãƒ™ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã­ï¼</p>
                <button onclick="closeLockModal()" class="w-full py-3 bg-pink-400 hover:bg-pink-500 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all">ã‚ã‹ã£ãŸï¼</button>
            </div>
        </div>
    </div>

    <!-- ç´™å¹é›ªæç”»ç”¨ -->
    <canvas id="confetti-canvas"></canvas>

    <script>
        /**
         * ã‚¢ãƒ—ãƒªã®çŠ¶æ…‹ç®¡ç† (State Management)
         */
        const APP_ID = 'yakubun_master_v1'; 
        const MAX_LEVEL = 10;
        
        let state = {
            // ã‚²ãƒ¼ãƒ é€²è¡Œ
            num: 0, den: 0,           // ç¾åœ¨ã®å•é¡Œï¼ˆåˆ†å­ã€åˆ†æ¯ï¼‰
            correctNum: 0, correctDen: 0, // æ­£è§£
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é€²æ—
            level: 1,
            maxUnlockedLevel: 1,
            solvedInLevel: 0,
            totalSolved: 0,
            
            // UIçŠ¶æ…‹
            activeBox: 'num',         // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ä¸­ã®å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ ('num' or 'den')
            userNum: '', userDen: '', // ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤
            
            // è¨­å®š
            charEmoji: 'ğŸ¦‰', charName: 'ãƒ•ã‚¯ãƒ­ã‚¦',
            
            // å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ç”¨
            levelProblemList: [],     // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã®å•é¡Œãƒªã‚¹ãƒˆ
            currentListIndex: 0,
            isMemoMode: false,
            isAnswering: true         // è§£ç­”å—ä»˜ä¸­ã‹ã©ã†ã‹
        };

        /**
         * Web Audio API ã«ã‚ˆã‚‹ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³
         * å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã‚ãšã€ãƒ–ãƒ©ã‚¦ã‚¶ã§éŸ³ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
         */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration, volume = 0.1) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œæ™‚ã«ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å†é–‹ï¼ˆiOSå¯¾ç­–ï¼‰
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            // éŸ³ã®æ¸›è¡°ï¼ˆè‡ªç„¶ãªéŸ¿ãã«ã™ã‚‹ï¼‰
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const SFX = {
            // æ­£è§£éŸ³ï¼ˆãƒ”ãƒ³ãƒãƒ³ï¼ï¼‰: é«˜ã„ãƒ‰ -> é«˜ã„ãƒŸ
            correct: () => { 
                playTone(1046.50, 'sine', 0.15, 0.1);
                setTimeout(() => playTone(1318.51, 'sine', 0.4, 0.1), 100);
            },
            // ä¸æ­£è§£éŸ³ï¼ˆãƒ–ãƒ–ãƒ¼ï¼‰: ä½ã„ãƒ©
            wrong: () => { playTone(220, 'triangle', 0.3, 0.15); },
            // ãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ï¼ˆã‚¯ãƒªã‚¢æ™‚ï¼‰: ãƒ¡ã‚¸ãƒ£ãƒ¼ã‚³ãƒ¼ãƒ‰åˆ†æ•£å’ŒéŸ³
            fanfare: () => { 
                [523, 659, 783, 1046].forEach((f, i) => {
                    setTimeout(() => playTone(f, 'square', 0.4, 0.05), i * 120);
                });
            },
            // ã‚¿ãƒƒãƒ—éŸ³ï¼ˆãƒã‚³ãƒƒï¼‰
            tap: () => playTone(600, 'sine', 0.05, 0.05)
        };

        /**
         * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
         */
        // æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ã‚‹ (Greatest Common Divisor)
        function getGCD(a, b) { return b === 0 ? a : getGCD(b, a % b); }

        const praiseMessages = ["ã™ã”ã„ï¼", "ãã®èª¿å­ï¼", "æ­£è§£ï¼", "ã°ã£ã¡ã‚Šï¼", "ã‚„ã‚‹ã­ï¼", "å¤©æ‰ã‹ã‚‚ï¼"];

        // ãƒ¬ãƒ™ãƒ«ã”ã¨ã®å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        function getStartTalk(lv) {
            if (lv >= 10) return "ã¤ã„ã«ã“ã“ã¾ã§æ¥ãŸã­ï¼<br>ä¼èª¬ã®ç´„åˆ†ç‹ã«ãªã‚ã†ï¼";
            if (lv >= 8) return "ã™ã”ã„ãƒ¬ãƒ™ãƒ«ã ï¼<br>ã‚€ãšã‹ã—ã„å•é¡Œã‚‚ã¸ã£ã¡ã‚ƒã‚‰ï¼Ÿ";
            if (lv >= 5) return "ã‚‚ã†ã™ãé”äººã ã­ï¼<br>ã©ã‚“ã©ã‚“è§£ã„ã¦ã„ã“ã†ï¼";
            if (lv >= 3) return "ãªã‚Œã¦ããŸã‹ãªï¼Ÿ<br>æ•°ã‚’ã‚ˆãè¦‹ã¦è€ƒãˆã‚ˆã†ï¼"; 
            if (lv >= 2) return "ãƒ¬ãƒ™ãƒ«2ã«ãªã£ãŸã­ï¼<br>å°‘ã—ãšã¤é›£ã—ããªã‚‹ã‚ˆï¼";
            return "ã‚ˆã‚ã—ãã­ï¼<br>ã„ã£ã—ã‚‡ã« ãŒã‚“ã°ã‚ã†ï¼";
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®ä½ç½®èª¿æ•´ãƒ‡ãƒ¼ã‚¿
        // ãƒ’ãƒ¨ã‚³(ğŸ¥)ã‚’è¿½åŠ ã—ã¦èª¿æ•´
        const charOffsets = {
            'ğŸ¦‰': { hatY: { start: -12, game: -8 }, chestY: { start: 14, game: 10 } },
            'ğŸ¥': { hatY: { start: -12, game: -10 }, chestY: { start: 16, game: 12 } }, // ãƒ’ãƒ¨ã‚³ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            'ğŸ§¸': { hatY: { start: -18, game: -14 }, chestY: { start: 8, game: 4 } }
        };

        /**
         * ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
         */
        function updateAccessories(currentLevel) {
            const startAcc = document.getElementById('start-accessories');
            const gameAcc = document.getElementById('game-accessories');
            if(!startAcc || !gameAcc) return;
            startAcc.innerHTML = ''; gameAcc.innerHTML = '';
            
            // ã‚ªãƒ¼ãƒ©ã®æ›´æ–°
            const startAura = document.getElementById('start-aura');
            const gameAura = document.getElementById('game-aura');
            
            // ã‚ªãƒ¼ãƒ©ã®ã‚¹ã‚¿ã‚¤ãƒ«ç”Ÿæˆé–¢æ•°
            const getAuraClass = (lv) => {
                if (lv >= 10) return "aura-bg legend-aura"; // ä¼èª¬ï¼šè¼ã
                if (lv >= 7) return "aura-bg bg-yellow-200 opacity-60"; // é‡‘
                if (lv >= 6) return "aura-bg bg-gray-200 opacity-60"; // éŠ€
                if (lv >= 5) return "aura-bg bg-orange-200 opacity-50"; // éŠ…
                return ""; // ãªã—
            };
            
            const lv = currentLevel || state.level;
            const auraClass = getAuraClass(lv);
            if (auraClass) {
                if(startAura) startAura.className = auraClass;
                if(gameAura) gameAura.className = auraClass;
            } else {
                if(startAura) startAura.className = "";
                if(gameAura) gameAura.className = "";
            }

            if (lv < 2) return;

            const offsets = charOffsets[state.charEmoji] || charOffsets['ğŸ¦‰'];
            
            // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼å®šç¾©ï¼ˆç§°å·ã¨ã®æ•´åˆæ€§ã‚’ä¿®æ­£ç‰ˆ + Lv8ä»¥é™ã®2ç‚¹ç››ã‚Šå¯¾å¿œï¼‰
            const configs = {
                2: { emoji: 'ğŸŒ±', start: `top:${offsets.hatY.start - 10}px; right:-15px; font-size:1.5rem; transform: rotate(20deg);`, game: `top:${offsets.hatY.game - 5}px; right:-8px; font-size:1.0rem; transform: rotate(20deg);` }, // è¦‹ç¿’ã„ï¼è‹¥è‘‰
                3: { emoji: 'â­', start: 'top:0px; left:-25px; font-size:1.8rem;', game: 'top:2px; left:-6px; font-size:1.0rem;' }, // æœŸå¾…ã®æ˜Ÿï¼æ˜Ÿ
                4: { emoji: 'ğŸ“', start: `top:${offsets.hatY.start}px; left:50%; transform:translateX(-50%); font-size:1.6rem;`, game: `top:${offsets.hatY.game}px; left:50%; transform:translateX(-50%); font-size:0.9rem;` }, // ã¯ã‹ã›ï¼è§’å¸½
                
                // --- ãƒ¡ãƒ€ãƒ«ã®ä½ç½®ã‚’èª¿æ•´ï¼ˆå°‘ã—ä¸‹ã’ã‚‹ï¼‰ ---
                5: { emoji: 'ğŸ¥‰', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, // éŠ…ãƒ¡ãƒ€ãƒªã‚¹ãƒˆ
                6: { emoji: 'ğŸ¥ˆ', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, // éŠ€ã®è¨ˆç®—å£«
                7: { emoji: 'ğŸ¥‡', start: `bottom:${offsets.chestY.start - 8}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 4}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, // é»„é‡‘ã®è³¢è€…
                
                8: { // ç´„åˆ†ãƒã‚¹ã‚¿ãƒ¼ï¼ˆ2ç‚¹è£…å‚™ï¼šãƒˆãƒ­ãƒ•ã‚£ãƒ¼ï¼‹å‹²ç« ï¼‰
                    multi: [
                        { emoji: 'ğŸ†', start: 'bottom:0px; right:-25px; font-size:2.0rem;', game: 'bottom:0px; right:-12px; font-size:1.2rem;' },
                        { emoji: 'ğŸ–ï¸', start: `bottom:${offsets.chestY.start - 10}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game - 5}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                    ]
                },
                9: { // å¤©æ‰ç´„åˆ†å¸«ï¼ˆ2ç‚¹è£…å‚™ï¼šæ–ï¼‹å®çŸ³ï¼‰
                    multi: [
                        { emoji: 'ğŸª„', start: 'top:10px; right:-25px; font-size:2.0rem; transform: rotate(15deg);', game: 'top:5px; right:-12px; font-size:1.2rem; transform: rotate(15deg);' },
                        { emoji: 'ğŸ’', start: `bottom:${offsets.chestY.start}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `bottom:${offsets.chestY.game}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }
                    ]
                },
                10: { // ä¼èª¬ã®ç´„åˆ†ç‹ï¼ˆ4ç‚¹è£…å‚™ï¼šç‹å† ï¼‹æ–ï¼‹èµ¤ãƒãƒ³ãƒˆï¼‹å¤ªé™½ã®ã‚¨ãƒ³ãƒ–ãƒ¬ãƒ ï¼‰
                    multi: [
                        { emoji: 'ğŸ‘‘', start: `top:${offsets.hatY.start - 4}px; left:50%; transform:translateX(-50%); font-size:1.8rem;`, game: `top:${offsets.hatY.game - 2}px; left:50%; transform:translateX(-50%); font-size:1.0rem;` }, // ç‹å† ï¼ˆä½ç½®ä¸‹ã’ï¼‰
                        { emoji: 'ğŸª„', start: 'top:10px; right:-25px; font-size:2.0rem; transform: rotate(15deg);', game: 'top:5px; right:-12px; font-size:1.2rem; transform: rotate(15deg);' },
                        // ãƒãƒ³ãƒˆã¯CSSæç”»ã«å¤‰æ›´ï¼ˆçµµæ–‡å­—ã ã¨é»„è‰²ã¨è¢«ã‚‹ãŸã‚ï¼‰
                        { type: 'css', className: 'red-cape' },
                        // å¤ªé™½ã®ã‚¨ãƒ³ãƒ–ãƒ¬ãƒ ï¼ˆä½ç½®èª¿æ•´ï¼šå°‘ã—ä¸‹ã’ã‚‹ï¼‰
                        { emoji: 'â˜€ï¸', start: `bottom:${offsets.chestY.start - 10}px; left:50%; transform:translateX(-50%); font-size:1.8rem; z-index:21; filter: drop-shadow(0 0 5px orange);`, game: `bottom:${offsets.chestY.game - 5}px; left:50%; transform:translateX(-50%); font-size:1.0rem; z-index:21;` }
                    ]
                }
            };

            const config = configs[lv] || (lv > 10 ? configs[10] : null);
            if (!config) return;

            const createEl = (item, style) => {
                const div = document.createElement('div');
                if (item.type === 'css') {
                    div.className = item.className; // CSSã‚¯ãƒ©ã‚¹ã§æç”»
                } else {
                    div.className = 'accessory';
                    div.style = style;
                    div.innerText = item.emoji;
                }
                return div;
            };
            
            if (config.multi) {
                config.multi.forEach(c => {
                    // CSSã‚¿ã‚¤ãƒ—ã¨çµµæ–‡å­—ã‚¿ã‚¤ãƒ—ã§åˆ†å²
                    if (c.type === 'css') {
                        startAcc.appendChild(createEl(c, null));
                        // ã‚²ãƒ¼ãƒ ç”»é¢ç”¨ã«ã‚‚ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦è¿½åŠ 
                        const clone = createEl(c, null);
                        gameAcc.appendChild(clone);
                    } else {
                        const elStart = createEl({emoji: c.emoji}, c.start);
                        startAcc.appendChild(elStart);
                        const elGame = createEl({emoji: c.emoji}, c.game);
                        gameAcc.appendChild(elGame);
                    }
                });
            } else if (config.emoji) {
                startAcc.appendChild(createEl({emoji: config.emoji}, config.start));
                gameAcc.appendChild(createEl({emoji: config.emoji}, config.game));
            }
        }

        // ç§°å·ã®ç”Ÿæˆ
        function getLevelTitle(lv) {
            // ãƒ¬ãƒ™ãƒ«ã”ã¨ã«ç•°ãªã‚‹ç§°å·ã‚’å®šç¾©
            const titles = {
                1: "ã‹ã‘ã ã—",
                2: "è¦‹ç¿’ã„",
                3: "æœŸå¾…ã®æ˜Ÿ",
                4: "æ•°å­¦ã¯ã‹ã›",
                5: "éŠ…ãƒ¡ãƒ€ãƒªã‚¹ãƒˆ",
                6: "éŠ€ã®è¨ˆç®—å£«",
                7: "é»„é‡‘ã®è³¢è€…",
                8: "ç´„åˆ†ãƒã‚¹ã‚¿ãƒ¼",
                9: "å¤©æ‰ç´„åˆ†å¸«",
                10: "ä¼èª¬ã®ç´„åˆ†ç‹"
            };
            return titles[lv] || "ã‹ã‘ã ã—";
        }

        function updateTitleAndPreview() {
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤ºæ›´æ–°
            document.getElementById('preview-emoji').innerText = state.charEmoji;
            document.getElementById('game-char').innerText = state.charEmoji;
            
            // ç§°å·æ›´æ–°
            let titleText = getLevelTitle(state.level) + " " + state.charName;
            const titleEl = document.getElementById('title-label');
            titleEl.innerText = titleText;
            
            // ãƒ¬ãƒ™ãƒ«ã«ã‚ˆã‚‹è‰²å¤‰ãˆ
            if (state.level >= 10) {
                titleEl.className = "text-lg font-bold text-yellow-600 bg-yellow-100 px-6 py-1 rounded-full border-2 border-yellow-400";
            } else if (state.level >= 5) {
                titleEl.className = "text-lg font-bold text-blue-500 bg-blue-50 px-6 py-1 rounded-full border-2 border-blue-200";
            } else {
                titleEl.className = "text-lg font-bold text-pink-500 bg-pink-50 px-6 py-1 rounded-full border border-pink-100";
            }

            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®é¸æŠçŠ¶æ…‹
            document.getElementById('level-select').value = state.level;
            
            // é€²æ—ãƒãƒ¼æ›´æ–°
            document.getElementById('total-solved-display').innerText = state.totalSolved;
            const progressPercent = Math.min(100, (state.totalSolved / 100) * 100);
            document.getElementById('progress-fill').style.width = `${progressPercent}%`;

            // å¹ãå‡ºã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            document.getElementById('start-char-talk').innerHTML = getStartTalk(state.level);
            
            // ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼åæ˜ 
            updateAccessories(state.level);
        }

        // ãƒ¬ãƒ™ãƒ«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®ç”Ÿæˆ
        function initLevelSelect() {
            const select = document.getElementById('level-select');
            select.innerHTML = '';
            for(let i = 1; i <= MAX_LEVEL; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `ãƒ¬ãƒ™ãƒ« ${i}`;
                if (i > state.maxUnlockedLevel) {
                    opt.innerText += " (ğŸ”’)";
                }
                select.appendChild(opt);
            }
        }

        /**
         * ã‚¢ãƒ—ãƒªæ“ä½œã‚¢ã‚¯ã‚·ãƒ§ãƒ³
         */
        function changeLevel(newLv) {
            SFX.tap();
            const targetLv = parseInt(newLv);
            
            // ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãŸã‚‰æˆ»ã™
            if (targetLv > state.maxUnlockedLevel) {
                showLockModal(`ãƒ¬ãƒ™ãƒ«${state.maxUnlockedLevel}ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã­ï¼`);
                document.getElementById('level-select').value = state.level;
                return;
            }
            
            state.level = targetLv;
            state.solvedInLevel = 0; // ãƒ¬ãƒ™ãƒ«ã‚’å¤‰ãˆãŸã‚‰ãã®ãƒ¬ãƒ™ãƒ«ã®é€²æ—ã¯ãƒªã‚»ãƒƒãƒˆ
            state.levelProblemList = [];
            
            updateAccessories(state.level);
            updateTitleAndPreview();
            save();
        }

        function showLockModal(msg) {
            const modal = document.getElementById('lock-modal');
            const msgEl = document.getElementById('lock-message');
            msgEl.innerText = msg;
            modal.classList.remove('hidden');
        }

        function closeLockModal() {
            SFX.tap();
            document.getElementById('lock-modal').classList.add('hidden');
        }

        function selectChar(emoji, name) {
            SFX.tap();
            state.charEmoji = emoji;
            state.charName = name;
            updateTitleAndPreview();
            save();
        }

        function startGame() {
            SFX.tap();
            // ç”»é¢é·ç§»
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            
            // å•é¡Œãƒªã‚¹ãƒˆç”Ÿæˆï¼ˆãªã‘ã‚Œã°ï¼‰
            if (state.levelProblemList.length === 0) generateLevelList();
            createQuestion();
        }

        function backToStart() {
            SFX.tap();
            // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ä¿å­˜
            updateAccessories(state.level);
            updateTitleAndPreview();
            initLevelSelect(); // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®æ›´æ–°åæ˜ 
            
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('game-ui').classList.add('hidden');
            
            // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ãªã‚‰è§£é™¤
            if(state.isMemoMode) toggleMemo();
        }

        /**
         * å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯
         */
        function generateLevelList() {
            let maxAns, mMin, mMax, filterLevel6Plus = false;
            
            // é›£æ˜“åº¦èª¿æ•´ãƒ­ã‚¸ãƒƒã‚¯
            if (state.level === 1) { maxAns = 6; mMin = 2; mMax = 3; } 
            else if (state.level === 2) { maxAns = 10; mMin = 2; mMax = 5; } 
            else if (state.level === 3) { maxAns = 12; mMin = 3; mMax = 7; } 
            else if (state.level === 4) { maxAns = 15; mMin = 3; mMax = 9; }
            else if (state.level === 5) { maxAns = 18; mMin = 3; mMax = 12; }
            else if (state.level >= 6) {
                maxAns = 20 + (state.level - 6) * 5; 
                mMin = 4 + Math.floor(state.level / 3);
                mMax = 12 + Math.floor(state.level / 2);
                filterLevel6Plus = true; 
            }

            // æ—¢ç´„åˆ†æ•°ã®ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆ
            let pool = [];
            for (let d = 2; d <= maxAns; d++) {
                for (let n = 1; n < d; n++) {
                    if (getGCD(n, d) === 1) {
                        // é«˜ãƒ¬ãƒ™ãƒ«ã§ã¯å˜ç´”ã™ãã‚‹å•é¡Œï¼ˆ1/2ãªã©ï¼‰ã‚’å°‘ã—æ¸›ã‚‰ã™
                        if (filterLevel6Plus && n === 1 && d <= 3) continue;
                        pool.push({ an: n, ad: d });
                    }
                }
            }

            // å•é¡Œã‚’10å•ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
            let tempQuestions = [];
            let safetyCounter = 0;
            while (tempQuestions.length < 10 && safetyCounter < 1000) {
                safetyCounter++;
                const base = pool[Math.floor(Math.random() * pool.length)];
                if (!base) continue;
                
                // å€ç‡ï¼ˆmï¼‰ã‚’ãƒ©ãƒ³ãƒ€ãƒ æ±ºå®š
                let m = Math.floor(Math.random() * (mMax - mMin + 1)) + mMin;
                const qn = base.an * m; 
                const qd = base.ad * m;
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã‚­ãƒ¼
                const key = `${qn}/${qd}`;
                
                // 3æ¡ä»¥å†…ã‹ã¤é‡è¤‡ãªã—ãªã‚‰æ¡ç”¨
                if (qd < 1000 && !tempQuestions.some(q => q.key === key)) {
                    tempQuestions.push({ an: base.an, ad: base.ad, qn: qn, qd: qd, key: key });
                }
            }
            // åˆ†æ¯ãŒå°ã•ã„é †ã«ã‚½ãƒ¼ãƒˆï¼ˆè§£ãã‚„ã™ãã™ã‚‹ï¼‰
            state.levelProblemList = tempQuestions.sort((a, b) => a.qd - b.qd);
            state.currentListIndex = 0;
            state.solvedInLevel = 0;
        }

        function createQuestion() {
            state.isAnswering = true;
            
            // å…¨å•çµ‚äº†æ™‚ã¯å†ç”Ÿæˆ
            if (state.currentListIndex >= state.levelProblemList.length) generateLevelList();
            
            const p = state.levelProblemList[state.currentListIndex];
            state.num = p.qn; state.den = p.qd;
            state.correctNum = p.an; state.correctDen = p.ad;
            
            // å…¥åŠ›æ¬„ãƒªã‚»ãƒƒãƒˆ
            state.userNum = ''; state.userDen = '';
            state.activeBox = 'num'; // åˆ†å­ã‹ã‚‰å…¥åŠ›ã‚¹ã‚¿ãƒ¼ãƒˆ
            
            document.getElementById('correct-overlay').classList.add('hidden');
            document.getElementById('feedback-text').innerText = "ç´„åˆ†ã—ã¦ã¿ã‚ˆã†ï¼";
            
            clearMemo();
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('q-num').innerText = state.num;
            document.getElementById('q-den').innerText = state.den;
            
            document.getElementById('box-num').innerText = state.userNum || '?';
            document.getElementById('box-den').innerText = state.userDen || '?';
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå…¥åŠ›æ¬„ã‚’å¼·èª¿
            const baseClass = "input-box w-20 h-16 sm:w-24 sm:h-20 flex items-center justify-center text-4xl font-bold border-4 rounded-2xl";
            
            document.getElementById('box-num').className = `${baseClass} ${state.activeBox === 'num' ? 'active border-blue-400 bg-blue-50' : 'bg-gray-50 border-gray-200 text-gray-400'}`;
            document.getElementById('box-den').className = `${baseClass} ${state.activeBox === 'den' ? 'active border-blue-400 bg-blue-50' : 'bg-gray-50 border-gray-200 text-gray-400'}`;
            
            // æ–‡å­—è‰²ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ¶å¾¡
            if(state.userNum) document.getElementById('box-num').classList.add('text-blue-600');
            if(state.userDen) document.getElementById('box-den').classList.add('text-blue-600');

            document.getElementById('display-level').innerText = state.level;
            document.getElementById('display-remain').innerText = 10 - state.solvedInLevel;
        }

        function switchFocus(box) { 
            if(!state.isAnswering) return; 
            SFX.tap(); 
            state.activeBox = box; 
            updateDisplay(); 
        }

        function inputNum(n) {
            if(!state.isAnswering) return;
            SFX.tap();
            // 3æ¡ã¾ã§å…¥åŠ›å¯
            if (state.activeBox === 'num') { 
                if (state.userNum.length < 3) state.userNum += n; 
            } else { 
                if (state.userDen.length < 3) state.userDen += n; 
            }
            updateDisplay();
        }

        function clearNum() { 
            if(!state.isAnswering) return; 
            SFX.tap(); 
            if (state.activeBox === 'num') state.userNum = ''; 
            else state.userDen = ''; 
            updateDisplay(); 
        }

        function checkAnswer() {
            if(!state.isAnswering) return;
            
            const uNum = parseInt(state.userNum);
            const uDen = parseInt(state.userDen);
            const feedbackEl = document.getElementById('feedback-text');
            const overlayEl = document.getElementById('correct-overlay');
            
            // æœªå…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (isNaN(uNum) || isNaN(uDen)) { 
                feedbackEl.innerText = "æ•°å­—ã‚’å…¥ã‚Œã¦ã­ï¼"; 
                SFX.wrong();
                return; 
            }
            
            // æ­£èª¤åˆ¤å®š
            if (uNum === state.correctNum && uDen === state.correctDen) {
                // --- æ­£è§£ï¼ ---
                state.isAnswering = false; 
                state.solvedInLevel++; 
                state.totalSolved++; 
                state.currentListIndex++;
                
                overlayEl.classList.remove('hidden'); // èŠ±ä¸¸è¡¨ç¤º
                feedbackEl.innerText = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
                SFX.correct();
                
                // ãƒ¬ãƒ™ãƒ«ã‚¯ãƒªã‚¢åˆ¤å®šï¼ˆ10å•æ­£è§£ï¼‰
                if (state.solvedInLevel >= 10) {
                    // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã‚’è§£æ”¾
                    if (state.level >= state.maxUnlockedLevel && state.level < MAX_LEVEL) {
                        state.maxUnlockedLevel = state.level + 1;
                    }
                    
                    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å‡¦ç†
                    state.level++; 
                    if(state.level > MAX_LEVEL) state.level = MAX_LEVEL; // ã‚«ãƒ³ã‚¹ãƒˆ
                    
                    state.levelProblemList = []; 
                    save();
                    
                    // ãŠç¥ã„æ¼”å‡º
                    setTimeout(() => { 
                        backToStart(); 
                        SFX.fanfare(); 
                        launchConfetti(); 
                        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«çš„ãªã‚‚ã®ã‚’å‡ºã™ä»£ã‚ã‚Šã«ã€ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ã‚­ãƒ£ãƒ©ãŒå¤‰åŒ–ã—ã¦ã„ã‚‹ã“ã¨ã§è¡¨ç¾
                    }, 1500);
                } else {
                    // æ¬¡ã®å•é¡Œã¸
                    save(); 
                    if (state.solvedInLevel % 5 === 0) launchConfetti(); // 5å•ã”ã¨ã«å°‘ã—ç´™å¹é›ª
                    setTimeout(createQuestion, 1500);
                }
            } else {
                // --- ä¸æ­£è§£ ---
                SFX.wrong();
                // ãƒ’ãƒ³ãƒˆå‡ºã—
                if (uNum / uDen === state.num / state.den) {
                    feedbackEl.innerText = "ã¾ã å‰²ã‚Œã‚‹ã‚ˆï¼";
                } else {
                    feedbackEl.innerText = "è¨ˆç®—ã—ãªãŠã—ã¦ã¿ã‚ˆã†ï¼";
                }
                // å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                state.userNum = ''; state.userDen = ''; 
                updateDisplay();
            }
        }

        /**
         * ãƒ¡ãƒ¢æ©Ÿèƒ½ (Canvas)
         */
        const memoCanvas = document.getElementById('memo-canvas');
        const mCtx = memoCanvas.getContext('2d');
        let isDrawing = false;
        
        function toggleMemo() {
            SFX.tap(); 
            state.isMemoMode = !state.isMemoMode;
            
            const layer = document.getElementById('memo-layer');
            const btn = document.getElementById('memo-btn');
            
            if (state.isMemoMode) {
                layer.classList.remove('hidden');
                layer.classList.add('active'); // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆæœ‰åŠ¹åŒ–
                btn.innerHTML = '<span>âœ…</span> ã¨ã˜ã‚‹'; 
                btn.classList.replace('bg-blue-400', 'bg-green-500');
                btn.classList.replace('hover:bg-blue-500', 'hover:bg-green-600');
                
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºèª¿æ•´
                resizeMemoCanvas();
            } else {
                layer.classList.add('hidden');
                layer.classList.remove('active');
                btn.innerHTML = '<span>âœï¸</span> ãƒ¡ãƒ¢'; 
                btn.classList.replace('bg-green-500', 'bg-blue-400');
                btn.classList.replace('hover:bg-green-600', 'hover:bg-blue-500');
            }
        }
        
        function resizeMemoCanvas() {
            const layer = document.getElementById('memo-layer');
            const rect = layer.getBoundingClientRect();
            memoCanvas.width = rect.width; 
            memoCanvas.height = rect.height;
            
            // æç”»è¨­å®š
            mCtx.strokeStyle = '#2563EB'; // blue-600
            mCtx.lineWidth = 3; 
            mCtx.lineCap = 'round'; 
            mCtx.lineJoin = 'round';
        }
        
        function clearMemo() { 
            if(mCtx) mCtx.clearRect(0, 0, memoCanvas.width, memoCanvas.height); 
        }
        
        // æç”»ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        function getPos(e) {
            const rect = memoCanvas.getBoundingClientRect();
            // ãƒãƒ«ãƒã‚¿ãƒƒãƒå¯¾ç­–ï¼šæœ€åˆã®æŒ‡ã ã‘è¿½è·¡
            const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
            const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        
        function startDraw(e) { 
            if (!state.isMemoMode) return; 
            isDrawing = true; 
            const pos = getPos(e); 
            mCtx.beginPath(); 
            mCtx.moveTo(pos.x, pos.y); 
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
            if (e.type === 'touchstart') e.preventDefault(); 
        }
        
        function draw(e) { 
            if (!isDrawing) return; 
            const pos = getPos(e); 
            mCtx.lineTo(pos.x, pos.y); 
            mCtx.stroke(); 
            if (e.type === 'touchmove') e.preventDefault(); 
        }
        
        function stopDraw() { isDrawing = false; }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²
        memoCanvas.addEventListener('mousedown', startDraw); 
        memoCanvas.addEventListener('touchstart', startDraw, {passive: false});
        memoCanvas.addEventListener('mousemove', draw); 
        memoCanvas.addEventListener('touchmove', draw, {passive: false});
        window.addEventListener('mouseup', stopDraw); 
        window.addEventListener('touchend', stopDraw);

        /**
         * ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (Confetti)
         */
        const confCanvas = document.getElementById('confetti-canvas');
        const cCtx = confCanvas.getContext('2d');
        let particles = [];
        
        function launchConfetti() {
            confCanvas.width = window.innerWidth; 
            confCanvas.height = window.innerHeight;
            particles = [];
            
            // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
            const particleCount = 80;
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: confCanvas.width / 2, 
                    y: confCanvas.height / 2,
                    vx: (Math.random() - 0.5) * 15, 
                    vy: (Math.random() - 0.8) * 15,
                    size: Math.random() * 8 + 4, 
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`, 
                    gravity: 0.4,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10
                });
            }
            updateConfetti();
        }
        
        function updateConfetti() {
            cCtx.clearRect(0, 0, confCanvas.width, confCanvas.height);
            
            particles.forEach((p, i) => {
                p.x += p.vx; 
                p.y += p.vy; 
                p.vy += p.gravity;
                p.rotation += p.rotationSpeed;
                
                cCtx.save();
                cCtx.translate(p.x, p.y);
                cCtx.rotate(p.rotation * Math.PI / 180);
                cCtx.fillStyle = p.color; 
                cCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                cCtx.restore();
                
                // ç”»é¢å¤–ã«å‡ºãŸã‚‰å‰Šé™¤
                if (p.y > confCanvas.height) particles.splice(i, 1);
            });
            
            if (particles.length > 0) requestAnimationFrame(updateConfetti);
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– (Storage)
         */
        function save() { 
            try {
                localStorage.setItem(APP_ID, JSON.stringify({
                    level: state.level, 
                    maxUnlockedLevel: state.maxUnlockedLevel,
                    charEmoji: state.charEmoji, 
                    charName: state.charName,
                    totalSolved: state.totalSolved, 
                    solvedInLevel: state.solvedInLevel
                })); 
            } catch (e) {
                console.warn('Storage save failed:', e);
            }
        }
        
        function load() {
            try {
                const data = localStorage.getItem(APP_ID);
                if (data) {
                    const p = JSON.parse(data);
                    state.level = p.level || 1;
                    
                    // ã€ä¿®æ­£æ¸ˆã¿ã€‘å…¨ãƒ¬ãƒ™ãƒ«è§£æ”¾ã‚’è§£é™¤ã—ã€å…ƒã®ãƒ­ã‚¸ãƒƒã‚¯ã«æˆ»ã—ã¾ã—ãŸ
                    state.maxUnlockedLevel = Math.max(1, p.maxUnlockedLevel || 1);

                    state.charEmoji = p.charEmoji || 'ğŸ¦‰'; 
                    state.charName = p.charName || 'ãƒ•ã‚¯ãƒ­ã‚¦';
                    state.totalSolved = p.totalSolved || 0;
                    state.solvedInLevel = p.solvedInLevel || 0;
                } else {
                    // æ–°è¦ã®å ´åˆã¯ãƒ¬ãƒ™ãƒ«1ã®ã¿è§£æ”¾
                    state.maxUnlockedLevel = 1;
                }
            } catch (e) {
                console.warn('Storage load failed:', e);
                state.maxUnlockedLevel = 1;
            }
            // åˆæœŸåŒ–å‡¦ç†
            initLevelSelect();
            updateTitleAndPreview();
        }
        
        // ã‚¢ãƒ—ãƒªèµ·å‹•
        load();
        
        // ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚­ãƒ£ãƒ³ãƒã‚¹èª¿æ•´
        window.addEventListener('resize', () => {
            if(state.isMemoMode) resizeMemoCanvas();
        });
        
    </script>
</body>
</html>
